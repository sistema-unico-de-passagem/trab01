create database brutec;
use brutec;

CREATE TABLE CLIENTES(
ID_CLIENTE SERIAL NOT NULL,
Nome VARCHAR(100),
CPF VARCHAR(25) NOT NULL,
RG VARCHAR(20) NOT NULL,
Telefone VARCHAR(20),
Email VARCHAR(100),
Data_Nasc DATE,
Login VARCHAR(100),
Senha VARCHAR(100),
FK_END INT NOT NULL,
PRIMARY KEY(CPF)
)ENGINE = INNODB;



CREATE TABLE EMPRESAS(
CNPJ VARCHAR(40) NOT NULL PRIMARY KEY,
FK_END INT NOT NULL,
NOME VARCHAR(100),
TELEFONE VARCHAR(20),
EMAIL VARCHAR(100)
)engine = innodb;


CREATE TABLE ENDERECOS(
ID_ENDERECO SERIAL PRIMARY KEY NOT NULL,
RUA TEXT,
NUMERO INT,
BAIRRO TEXT,
CIDADE TEXT,
CEP VARCHAR(15),
ESTADO CHAR(2),
COMPLEMENTO TEXT
)engine = innodb;

CREATE TABLE CARTAO(
ID_CARTAO INT NOT NULL primary key ,
CPF VARCHAR(25) NOT NULL,
Numero_Cartao INTEGER NOT NULL,
Validade_Cartao DATE NOT NULL,
Tipo_Cartao VARCHAR(100) NOT NULL,
Senha_Cartao VARCHAR(100) NOT NULL
)engine = InnoDB;


CREATE TABLE TRANSACAO(
ID_TRANSACAO SERIAL NOT NULL PRIMARY KEY,
FK_ID_CARTAO  INT NOT NULL,
VALOR Double,
DATA_TRANSACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)engine = InnoDB; 

CREATE TABLE CARTAO_NFC(
NFC_UID_USUARIO VARCHAR(40) NOT NULL PRIMARY KEY,
CPF_PROPRIETARIO VARCHAR(40)REFERENCES CLIENTES(CPF),
DATA_CRIACAO_CARTAO DATE,aa
DATA_VALIDADE DATE
)engine = InnoDB;
ALTER TABLE CARTAO_NFC ADD COLUMN SALDO MONEY 

CREATE TABLE Validador(
NFC_UID_MAQUINA VARCHAR(40) NOT NULL PRIMARY KEY,
CNPJ_PROPRIETARIO VARCHAR(40)REFERENCES EMPRESAS (CNPJ),
DATA_CRIACAO DATE
)engine = InnoDB;

CREATE TABLE VIAGEM(
CODIGO_VIAGEM SERIAL NOT NULL PRIMARY KEY,
NUMERO_ONIBUS INT,
NOME_VIAGEM TEXT,
PLACA VARCHAR(12) NOT NULL,
PROPRIETARIA_ONIBUS VARCHAR(40) ,
FK_NFC_UID_MAQUINA VARCHAR(40) ,
HORARIO_SAIDA TIME,
DIA_VIAGEM DATE
)engine = InnoDB;

CREATE TABLE Log_maquina(
ID_log INT NOT NULL PRIMARY KEY,
FK_NFC_UID_USUARIO VARCHAR(40) ,
FK_NFC_UID_MAQUINA VARCHAR(40) ,
DATA_PASSAGEM DATE,
HORA_PASSAGEM TIME  
)engine = InnoDB;

CREATE TABLE TERMINAIS(
COD_TERMINAL INT NOT NULL PRIMARY KEY,
NOME VARCHAR(50),
FK_ENDERECO INT NOT NULL,
LINHAS TEXT,
TEL INT
)ENGINE = InnoDB;

CREATE TABLE ITINERARIOS(
COD_ITINERARIO INT NOT NULL PRIMARY KEY,
LOCAIS TEXT
)ENGINE = InnoDB;

CREATE TABLE HORARIOS(
COD_HORARIO INT NOT NULL PRIMARY KEY,
HORARIO TEXT
)ENGINE = InnoDB;

CREATE TABLE LINHA (
NUM_LINHA INT NOT NULL PRIMARY KEY,
DESCRICAO TEXT,
FK_ITIN INT NOT NULL,
FK_HR INT NOT NULL
)ENGINE = InnoDB;

ALTER TABLE CLIENTES ADD CONSTRAINT FK_ENDERECO FOREIGN KEY (FK_ENDERECO) REFERENCES ENDERECOS(ID_ENDERECO);

ALTER TABLE EMPRESAS ADD CONSTRAINT FK_END FOREIGN KEY (FK_END) REFERENCES ENDERECOS(ID_ENDERECO);

ALTER TABLE CARTAO ADD CONSTRAINT FK_CPF FOREIGN  KEY (CPF) REFERENCES CLIENTES (CPF);

ALTER TABLE TRANSACAO ADD CONSTRAINT FK_ID_CARTAO FOREIGN  KEY (FK_ID_CARTAO) REFERENCES CARTAO(ID_CARTAO),
ALTER TABLE TRANSACAO ADD CONSTRANT FK_NFC_CARTAO FOREIGN KEY FK_NFC_CARTAO REFERRENCE CARTAO_NFC (NFC_UID_USUARIO);

alter table Validador add column FK_ID_LOG int not null;
alter table validador add constraint FK_ID_LOG foreign key (FK_ID_LOG)references log_maquina(id_log);

ALTER TABLE VIAGEM ADD CONSTRAINT NUMERO_ONIBUS FOREIGN KEY (NUMERO_ONIBUS) REFERENCES LINHA(NUM_LINHA);
ALTER TABLE VIAGEM ADD CONSTRAINT FK_NFC_UID_MAQUINA FOREIGN KEY (FK_NFC_UID_MAQUINA) REFERENCES Validador(NFC_UID_MAQUINA);
ALTER TABLE VIAGEM ADD CONSTRAINT PROPRIETARIA_ONIBUS FOREIGN KEY (PROPRIETARIA_ONIBUS) REFERENCES EMPRESAS (CNPJ);

ALTER TABLE Log_maquina ADD CONSTRAINT FK_NFC_UID_USUARIO FOREIGN KEY (FK_NFC_UID_USUARIO) REFERENCES CARTAO_NFC(NFC_UID_USUARIO);

ALTER TABLE TERMINAIS ADD CONSTRAINT FK_ENDERECO FOREIGN KEY (FK_ENDERECO) REFERENCES ENDERECOS(ID_ENDERECO);

ALTER TABLE LINHA ADD CONSTRAINT FK_ITIN FOREIGN KEY(FK_ITIN) REFERENCES ITINERARIOS(COD_ITINERARIO);
ALTER TABLE LINHA ADD CONSTRAINT FK_HR FOREIGN KEY (FK_HR) REFERENCES HORARIOS(COD_HORARIO);


alter table viagem drop CONSTRAINT numero_onibus;
alter table linha drop CONSTRAINT linha_pkey;
alter table linha add column cod_linha int;

alter table linha add primary key (cod_linha);

alter table clientes drop CONSTRAINT fk_endereco;
alter table empresas drop CONSTRAINT fk_end;
alter table terminais drop CONSTRAINT fk_endereco;
alter table enderecos drop CONSTRAINT enderecos_pkey;
alter table enderecos drop column id_endereco;
alter table enderecos add column id_endereco serial primary key not null;
ALTER TABLE CLIENTES ADD CONSTRAINT FK_ENDERECO FOREIGN KEY(FK_END) REFERENCES ENDERECOS(ID_ENDERECO);
ALTER TABLE EMPRESAS ADD CONSTRAINT FK_END FOREIGN KEY(FK_END) REFERENCES ENDERECOS(ID_ENDERECO);
ALTER TABLE TERMINAIS ADD CONSTRAINT FK_ENDERECO FOREIGN KEY(FK_ENDERECO) REFERENCES ENDERECOS(ID_ENDERECO);

alter table CLIENTES drop column ID_CLIENTE;
alter table CLIENTES ADD column ID_CLIENTE SERIAL NOT NULL;

ALTER TABLE VALIDADOR DROP COLUMN FK_ID_LOG;

ALTER TABLE LOG_MAQUINA DROP COLUMN ID_LOG;
ALTER TABLE LOG_MAQUINA ADD COLUMN ID_LOG SERIAL PRIMARY KEY;

ALTER TABLE CARTAO DROP COLUMN ID_CARTAO;
ALTER TABLE CARTAO ADD COLUMN ID_CARTAO SERIAL PRIMARY KEY;
ALTER TABLE TRANSACAO ADD CONSTRAINT FK_ID_CARTAO FOREIGN KEY(FK_ID_CARTAO) REFERENCES CARTAO(ID_CARTAO);

ALTER TABLE CARTAO ALTER COLUMN NUMERO_CARTAO TYPE VARCHAR(20);

ALTER TABLE TERMINAIS DROP COLUMN COD_TERMINAL;
ALTER TABLE TERMINAIS ADD COLUMN COD_TERMINAL SERIAL PRIMARY KEY;

ALTER TABLE LOG_MAQUINA DROP COLUMN ID_LOG;
ALTER TABLE LOG_MAQUINA ADD COLUMN ID_LOG SERIAL PRIMARY KEY;

ALTER TABLE VIAGEM DROP COLUMN PROPRIETARIA_ONIBUS;